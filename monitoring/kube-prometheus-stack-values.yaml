# Grafana + Prometheus Stack - Production Configuration
# DNS: kishoregrafana.local

fullnameOverride: monitoring

# Grafana Configuration
grafana:
  enabled: true
  adminPassword: admin123  # Change in production!
  
  # Ingress for custom DNS
  ingress:
    enabled: true
    ingressClassName: istio
    hosts:
      - kishoregrafana.local
    tls:
      - secretName: grafana-tls-secret
        hosts:
          - kishoregrafana.local
  
  # Data sources - auto-configured
  additionalDataSources:
    - name: Loki
      type: loki
      url: http://loki:3100
      access: proxy
      isDefault: false
      jsonData:
        maxLines: 1000
    
    - name: Tempo
      type: tempo
      url: http://tempo:3100
      access: proxy
      isDefault: false
      jsonData:
        httpMethod: GET
        tracesToLogs:
          datasourceUid: loki
          tags: ['app', 'namespace']
          mappedTags: [{ key: 'service.name', value: 'app' }]
          mapTagNamesEnabled: true
          spanStartTimeShift: '-1h'
          spanEndTimeShift: '1h'
          filterByTraceID: true
          filterBySpanID: false
        tracesToMetrics:
          datasourceUid: prometheus
          tags: [{ key: 'service.name', value: 'service' }]
        serviceMap:
          datasourceUid: prometheus
        nodeGraph:
          enabled: true
        lokiSearch:
          datasourceUid: loki
  
  # Grafana plugins
  plugins:
    - grafana-clock-panel
    - grafana-piechart-panel
    - grafana-worldmap-panel
    - grafana-polystat-panel
    - redis-datasource
  
  # Dashboard provisioning
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: 'GitHub Gists API'
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  
  # Grafana configuration
  grafana.ini:
    server:
      root_url: https://kishoregrafana.local
    auth:
      disable_login_form: false
    auth.anonymous:
      enabled: true
      org_role: Viewer
    feature_toggles:
      enable: tempoSearch tempoBackendSearch traceToMetrics

# Prometheus Configuration
prometheus:
  enabled: true
  prometheusSpec:
    retention: 15d
    retentionSize: "10GB"
    
    # Scrape configs for our app
    additionalScrapeConfigs:
      - job_name: 'github-gists-api'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - production
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: pod
      
      - job_name: 'istio-mesh'
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - istio-system
        relabel_configs:
          - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: istio-telemetry;prometheus

# Alertmanager
alertmanager:
  enabled: true
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 1Gi

# Node exporter for infrastructure metrics
nodeExporter:
  enabled: true

# Kube-state-metrics
kubeStateMetrics:
  enabled: true

# Service monitors
serviceMonitor:
  enabled: true
