apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: monitoring
data:
  github-gists-api.json: |
    {
      "title": "GitHub Gists API - Full Observability",
      "uid": "github-gists-api-full",
      "timezone": "browser",
      "refresh": "5s",
      "tags": ["github-gists-api", "production", "loki", "tempo"],
      "panels": [
        {
          "id": 1,
          "title": "metrics",
          "type": "row",
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }
        },
        {
          "id": 2,
          "title": "Request Rate",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 8, "x": 0, "y": 1 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{job=~\".*github-gists.*\"}[5m]))",
              "legendFormat": "Total Requests"
            }
          ]
        },
        {
          "id": 3,
          "title": "P95 Latency",
          "type": "timeseries",
          "gridPos": { "h": 8, "w": 8, "x": 8, "y": 1 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{job=~\".*github-gists.*\"}[5m])) by (le)) * 1000",
              "legendFormat": "ms"
            }
          ]
        },
        {
          "id": 4,
          "title": "Error Rate",
          "type": "stat",
          "gridPos": { "h": 8, "w": 8, "x": 16, "y": 1 },
          "datasource": { "type": "prometheus", "uid": "prometheus" },
          "targets": [
            {
              "expr": "sum(rate(http_requests_total{status=~\"5..\"}[5m])) / sum(rate(http_requests_total[5m])) * 100",
              "legendFormat": "Error %"
            }
          ]
        },
        {
          "id": 5,
          "title": "logs",
          "type": "row",
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 9 }
        },
        {
          "id": 6,
          "title": "Application Logs (Loki)",
          "type": "logs",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 10 },
          "datasource": { "type": "loki", "uid": "loki" },
          "targets": [
            {
              "expr": "{namespace=\"production\", container=\"github-gists-api\"}",
              "refId": "A"
            }
          ],
          "options": {
            "showTime": true,
            "showLabels": false,
            "wrapLogMessage": true
          }
        },
        {
          "id": 7,
          "title": "traces",
          "type": "row",
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 20 }
        },
        {
          "id": 8,
          "title": "Recent Traces (Istio/Tempo)",
          "type": "table",
          "gridPos": { "h": 10, "w": 24, "x": 0, "y": 21 },
          "datasource": { "type": "tempo", "uid": "tempo" },
          "targets": [
            {
              "queryType": "traceql",
              "query": "{ .service.name = \"github-gists-api.production\" }",
              "refId": "A",
              "limit": 20
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {},
                "indexByName": {},
                "renameByName": {}
              }
            }
          ]
        }
      ]
    }
