name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]  # Match your runner labels
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
      INGRESS_HOST: gists.127.0.0.1.nip.io
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be available via Docker Desktop
          kubectl version --client

      - name: Ensure Kind cluster exists (kind-dev)
        run: |
          $clusters = kind get clusters 2>$null
          if ($clusters -notcontains "${{ env.CLUSTER_NAME }}") {
            Write-Host "Creating kind cluster ${{ env.CLUSTER_NAME }}..."
            @"
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
"@ | kind create cluster --name ${{ env.CLUSTER_NAME }} --config=-
          } else {
            Write-Host "Kind cluster ${{ env.CLUSTER_NAME }} already exists"
          }
      
      - name: Configure Kind cluster context (kind-dev)
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          kubectl cluster-info

      - name: Build local image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Install ingress-nginx (kind)
        run: |
          if (-not (kubectl get ns ingress-nginx -o name 2>$null)) {
            kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
          }
          kubectl wait --namespace ingress-nginx --for=condition=ready pod -l app.kubernetes.io/component=controller --timeout=180s
      
      - name: Load local image into Kind cluster (kind-dev)
        run: |
          # Load the locally built image into Kind (expects image tag github-gists-api:latest)
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
      
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret `
            --docker-server=https://index.docker.io/v1/ `
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} `
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} `
            --namespace=${{ env.NAMESPACE }} `
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kind cluster
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/servicemonitor.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=3m

      - name: Publish ingress (local hostname)
        run: |
          kubectl apply -f k8s/ingress-local.yaml
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=github-gists-api
          kubectl get svc -n ${{ env.NAMESPACE }} -l app=github-gists-api
      
      - name: Port forward and test
        run: |
          Start-Job -ScriptBlock {
            kubectl port-forward -n ${{ env.NAMESPACE }} svc/github-gists-api 8080:80
          }
          Start-Sleep -Seconds 5
          
          # Test health endpoint
          $response = Invoke-RestMethod http://localhost:8080/health
          Write-Host "Health check: $($response.status)"
          
          # Test metrics endpoint
          $metrics = Invoke-WebRequest http://localhost:8080/metrics
          Write-Host "Metrics endpoint: Available"
          
          Stop-Job -Name *
