name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
      CUSTOM_DNS: gists.kishore.local
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cluster context
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          Write-Host "‚úÖ Context set" -ForegroundColor Green

      - name: Build and load image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
          Write-Host "‚úÖ Image built and loaded" -ForegroundColor Green

      - name: Deploy application
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/ingress-nginx.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=2m
          Write-Host "‚úÖ Application deployed" -ForegroundColor Green

      - name: Setup MetalLB for LoadBalancer IP
        run: |
          # Check if MetalLB already installed
          $metallbNs = kubectl get namespace metallb-system --ignore-not-found=true 2>$null
          if ([string]::IsNullOrEmpty($metallbNs)) {
            Write-Host "Installing MetalLB..." -ForegroundColor Yellow
            kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
            
            # Wait for MetalLB pods
            Start-Sleep -Seconds 10
            kubectl wait --namespace metallb-system --for=condition=ready pod --selector=app=metallb --timeout=90s 2>$null
          }
          
          # Get Docker network subnet for Kind
          $kindNetwork = docker network inspect kind --format "{{range .IPAM.Config}}{{.Subnet}}{{end}}" 2>$null
          if ($kindNetwork) {
            # Extract base IP (e.g., 172.18.0.0/16 -> 172.18)
            $baseIP = ($kindNetwork -split '\.')[0..1] -join '.'
            $ipRange = "$baseIP.255.200-$baseIP.255.250"
            
            Write-Host "Configuring MetalLB IP pool: $ipRange" -ForegroundColor Yellow
            
            # Apply MetalLB configuration
            $metallbConfig = @"
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: kind-pool
  namespace: metallb-system
spec:
  addresses:
  - $ipRange
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: kind-l2
  namespace: metallb-system
spec:
  ipAddressPools:
  - kind-pool
"@
            $metallbConfig | kubectl apply -f -
            Write-Host "‚úÖ MetalLB configured" -ForegroundColor Green
          }

      - name: Patch Ingress for LoadBalancer
        run: |
          # Patch ingress-nginx to LoadBalancer type
          kubectl patch svc ingress-nginx-controller -n ingress-nginx -p '{"spec":{"type":"LoadBalancer"}}'
          
          # Wait for external IP
          $retries = 0
          while ($retries -lt 12) {
            $externalIP = kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>$null
            if ($externalIP) {
              Write-Host "‚úÖ LoadBalancer IP: $externalIP" -ForegroundColor Green
              break
            }
            Write-Host "Waiting for LoadBalancer IP... ($retries/12)"
            Start-Sleep -Seconds 5
            $retries++
          }

      - name: Test and display access URLs
        run: |
          # Get LoadBalancer IP
          $LB_IP = kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>$null
          
          if ($LB_IP) {
            Write-Host ""
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host "Testing API via LoadBalancer" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan
            
            # Test health
            try {
              $health = Invoke-RestMethod -Uri "http://${LB_IP}/health" -Headers @{ Host = "gists.local" } -TimeoutSec 10
              Write-Host "‚úÖ Health: $($health.status)" -ForegroundColor Green
            } catch {
              Write-Host "‚ùå Health check failed: $_" -ForegroundColor Red
            }
            
            # Test gists
            try {
              $gists = Invoke-RestMethod -Uri "http://${LB_IP}/octocat" -Headers @{ Host = "gists.local" } -TimeoutSec 10
              Write-Host "‚úÖ Gists: Found $($gists.Count) for octocat" -ForegroundColor Green
            } catch {
              Write-Host "‚ùå Gists failed: $_" -ForegroundColor Red
            }
            
            Write-Host ""
            Write-Host "========================================" -ForegroundColor Green
            Write-Host "üéâ DEPLOYMENT SUCCESSFUL!" -ForegroundColor Green
            Write-Host "========================================" -ForegroundColor Green
            Write-Host ""
            Write-Host "LoadBalancer IP: $LB_IP" -ForegroundColor Cyan
            Write-Host ""
            Write-Host "Access URLs (no port-forward needed!):" -ForegroundColor Yellow
            Write-Host "  curl -H 'Host: gists.local' http://$LB_IP/health" -ForegroundColor White
            Write-Host "  curl -H 'Host: gists.local' http://$LB_IP/octocat" -ForegroundColor White
            Write-Host "  curl -H 'Host: ${{ env.CUSTOM_DNS }}' http://$LB_IP/octocat" -ForegroundColor White
            Write-Host ""
            Write-Host "Or add to hosts file and use directly:" -ForegroundColor Yellow
            Write-Host "  $LB_IP gists.local ${{ env.CUSTOM_DNS }}" -ForegroundColor White
            Write-Host "  http://gists.local/octocat" -ForegroundColor White
            Write-Host "  http://${{ env.CUSTOM_DNS }}/octocat" -ForegroundColor White
            Write-Host ""
          } else {
            Write-Host "‚ö†Ô∏è  No LoadBalancer IP, using port-forward fallback" -ForegroundColor Yellow
            Write-Host "  kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8080:80" -ForegroundColor White
            Write-Host "  curl -H 'Host: gists.local' http://localhost:8080/octocat" -ForegroundColor White
          }
