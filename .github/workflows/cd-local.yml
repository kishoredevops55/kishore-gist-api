name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]  # Match your runner labels
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be available via Docker Desktop
          kubectl version --client

      - name: Ensure Kind cluster exists with ingress port mappings
        run: |
          $clusters = kind get clusters 2>$null
          if ($clusters -notcontains "${{ env.CLUSTER_NAME }}") {
            Write-Host "Creating kind cluster ${{ env.CLUSTER_NAME }} with ingress support..."
            
            # Create temporary kind config file
            $kindConfig = @'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          '@
            
            $kindConfig | Out-File -FilePath kind-config.yaml -Encoding utf8
            kind create cluster --name ${{ env.CLUSTER_NAME }} --config kind-config.yaml
            Remove-Item kind-config.yaml
            
            Write-Host "‚úÖ Kind cluster created with ingress port mappings"
          } else {
            Write-Host "‚úÖ Kind cluster ${{ env.CLUSTER_NAME }} already exists"
          }
      
      - name: Configure Kind cluster context (kind-dev)
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          kubectl cluster-info
      
      - name: Install ingress-nginx controller
        run: |
          # Check if ingress-nginx namespace exists
          $ingressNs = kubectl get namespace ingress-nginx --ignore-not-found=true
          if ([string]::IsNullOrEmpty($ingressNs)) {
            Write-Host "Installing ingress-nginx controller..."
            kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
            
            Write-Host "Waiting for ingress-nginx controller to be ready..."
            kubectl wait --namespace ingress-nginx `
              --for=condition=ready pod `
              --selector=app.kubernetes.io/component=controller `
              --timeout=180s
            
            Write-Host "‚úÖ Ingress-nginx controller installed and ready"
          } else {
            Write-Host "‚úÖ Ingress-nginx controller already installed"
            # Verify it's running
            kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller
          }

      - name: Build local image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Load local image into Kind cluster (kind-dev)
        run: |
          # Load the locally built image into Kind (expects image tag github-gists-api:latest)
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
      
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret `
            --docker-server=https://index.docker.io/v1/ `
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} `
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} `
            --namespace=${{ env.NAMESPACE }} `
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kind cluster
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/servicemonitor.yaml
          kubectl apply -f k8s/ingress-nginx.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=3m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=github-gists-api
          kubectl get ingress -n ${{ env.NAMESPACE }}
      
      - name: Configure local DNS (Windows hosts file)
        run: |
          $hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
          $dnsEntry = "127.0.0.1 gists.local"
          
          # Check if entry already exists
          $existingEntry = Get-Content $hostsFile | Select-String -Pattern "gists.local"
          
          if (-not $existingEntry) {
            Write-Host "Adding DNS entry to hosts file..."
            Add-Content -Path $hostsFile -Value "`n$dnsEntry" -Force
            Write-Host "‚úÖ Added: $dnsEntry"
          } else {
            Write-Host "‚úÖ DNS entry already exists: $existingEntry"
          }
      
      - name: Wait for ingress to be ready
        run: |
          Write-Host "Waiting for ingress to configure load balancer..."
          Start-Sleep -Seconds 10
          
          # Verify ingress backend
          kubectl describe ingress github-gists-api -n ${{ env.NAMESPACE }}
      
      - name: Test API via Ingress (Production-grade)
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing API via Ingress Load Balancer" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          # Test health endpoint
          Write-Host "Testing: http://gists.local/health"
          try {
            $health = Invoke-RestMethod -Uri "http://gists.local/health" -TimeoutSec 10
            Write-Host "‚úÖ Health check: $($health.status)" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Health check failed: $_" -ForegroundColor Red
            exit 1
          }
          
          # Test metrics endpoint
          Write-Host ""
          Write-Host "Testing: http://gists.local/metrics"
          try {
            $metrics = Invoke-WebRequest -Uri "http://gists.local/metrics" -UseBasicParsing -TimeoutSec 10
            if ($metrics.Content -like "*http_requests_total*") {
              Write-Host "‚úÖ Metrics endpoint working" -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ùå Metrics check failed: $_" -ForegroundColor Red
            exit 1
          }
          
          # Test gists endpoint
          Write-Host ""
          Write-Host "Testing: http://gists.local/octocat"
          try {
            $gists = Invoke-RestMethod -Uri "http://gists.local/octocat" -TimeoutSec 10
            Write-Host "‚úÖ Found $($gists.Count) gists for octocat" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Gists endpoint failed: $_" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üéâ All API tests passed!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Access your API at: http://gists.local/<username>" -ForegroundColor Yellow
          Write-Host "Example: http://gists.local/octocat" -ForegroundColor Yellow
          Write-Host ""
          Stop-Job -Name *
