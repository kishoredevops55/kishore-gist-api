name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]  # Match your runner labels
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be available via Docker Desktop
          kubectl version --client

      - name: Ensure Kind cluster exists with ingress port mappings
        run: |
          $clusters = kind get clusters 2>$null
          if ($clusters -notcontains "${{ env.CLUSTER_NAME }}") {
            Write-Host "Creating kind cluster ${{ env.CLUSTER_NAME }} with ingress support..."
            
            # Create temporary kind config file
            $kindConfig = @'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          '@
            
            $kindConfig | Out-File -FilePath kind-config.yaml -Encoding utf8
            kind create cluster --name ${{ env.CLUSTER_NAME }} --config kind-config.yaml
            Remove-Item kind-config.yaml
            
            Write-Host "âœ… Kind cluster created with ingress port mappings"
          } else {
            Write-Host "âœ… Kind cluster ${{ env.CLUSTER_NAME }} already exists"
          }
      
      - name: Configure Kind cluster context (kind-dev)
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          kubectl cluster-info
      
      - name: Install ingress-nginx controller
        run: |
          # Check if ingress-nginx namespace exists
          $ingressNs = kubectl get namespace ingress-nginx --ignore-not-found=true
          if ([string]::IsNullOrEmpty($ingressNs)) {
            Write-Host "Installing ingress-nginx controller..."
            kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
            
            Write-Host "Waiting for ingress-nginx controller to be ready..."
            kubectl wait --namespace ingress-nginx `
              --for=condition=ready pod `
              --selector=app.kubernetes.io/component=controller `
              --timeout=180s
            
            Write-Host "âœ… Ingress-nginx controller installed and ready"
          } else {
            Write-Host "âœ… Ingress-nginx controller already installed"
            # Verify it's running
            kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller
          }

      - name: Build local image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Load local image into Kind cluster (kind-dev)
        run: |
          # Load the locally built image into Kind (expects image tag github-gists-api:latest)
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
      
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret `
            --docker-server=https://index.docker.io/v1/ `
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} `
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} `
            --namespace=${{ env.NAMESPACE }} `
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kind cluster
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/servicemonitor.yaml
          kubectl apply -f k8s/ingress-nginx.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=3m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=github-gists-api
          kubectl get ingress -n ${{ env.NAMESPACE }}
      
      - name: Configure local DNS (Windows hosts file)
        continue-on-error: true
        run: |
          $hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
          $dnsEntry = "127.0.0.1 gists.local"
          
          # Check if entry already exists
          $existingEntry = Get-Content $hostsFile | Select-String -Pattern "gists.local"
          
          if (-not $existingEntry) {
            Write-Host "âš ï¸  DNS entry not found in hosts file" -ForegroundColor Yellow
            Write-Host "Please run as Administrator:" -ForegroundColor Yellow
            Write-Host "  Add-Content -Path C:\Windows\System32\drivers\etc\hosts -Value '127.0.0.1 gists.local'" -ForegroundColor Cyan
            Write-Host ""
            Write-Host "Or manually add this line to C:\Windows\System32\drivers\etc\hosts:" -ForegroundColor Yellow
            Write-Host "  127.0.0.1 gists.local" -ForegroundColor Cyan
          } else {
            Write-Host "âœ… DNS entry already exists: $existingEntry" -ForegroundColor Green
          }
      
      - name: Wait for ingress and Test API
        run: |
          Write-Host "Waiting for ingress controller and backends to be ready..." -ForegroundColor Yellow
          Write-Host ""
          
          # Wait for ingress controller pods
          kubectl wait --namespace ingress-nginx `
            --for=condition=ready pod `
            --selector=app.kubernetes.io/component=controller `
            --timeout=60s
          
          Write-Host "âœ… Ingress controller is ready" -ForegroundColor Green
          Write-Host ""
          
          # Wait for application pods
          kubectl wait --namespace ${{ env.NAMESPACE }} `
            --for=condition=ready pod `
            --selector=app=github-gists-api `
            --timeout=60s
          
          Write-Host "âœ… Application pods are ready" -ForegroundColor Green
          Write-Host ""
          
          # Setup port-forward to ingress controller (use 8080 to avoid admin requirement)
          Write-Host "Setting up port-forward to ingress controller on port 8080..." -ForegroundColor Yellow
          $ingressPod = kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o jsonpath="{.items[0].metadata.name}"
          
          # Start background job for port forward (8080->80)
          $pfJob = Start-Job -ScriptBlock {
            param($podName)
            kubectl port-forward -n ingress-nginx pod/$podName 8080:80 2>&1
          } -ArgumentList $ingressPod
          
          Write-Host "Waiting for port-forward to accept connections..."
          Start-Sleep -Seconds 8
          
          # Verify port-forward is running
          $jobState = Get-Job -Id $pfJob.Id
          Write-Host "Port-forward job state: $($jobState.State)"
          
          # Show ingress details
          Write-Host ""
          Write-Host "Ingress details:" -ForegroundColor Cyan
          kubectl describe ingress github-gists-api -n ${{ env.NAMESPACE }}
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing API via Ingress Load Balancer" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          $baseUrl = "http://localhost:8080"
          
          # Test health endpoint
          Write-Host "Testing: $baseUrl/health"
          try {
            $health = Invoke-RestMethod -Uri "$baseUrl/health" -Headers @{ Host = "gists.local" } -TimeoutSec 15
            Write-Host "âœ… Health check: $($health.status)" -ForegroundColor Green
          } catch {
            Write-Host "âŒ Health check failed: $_" -ForegroundColor Red
            Write-Host ""
            Write-Host "Port-forward job output:" -ForegroundColor Yellow
            Receive-Job -Id $pfJob.Id
            Write-Host ""
            Write-Host "Troubleshooting:" -ForegroundColor Yellow
            Write-Host "1. Ingress controller logs:"
            kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=30
            Write-Host ""
            Write-Host "2. Application logs:"
            kubectl logs -n ${{ env.NAMESPACE }} -l app=github-gists-api --tail=30
            Stop-Job -Id $pfJob.Id -ErrorAction SilentlyContinue
            Remove-Job -Id $pfJob.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          
          # Test metrics endpoint
          Write-Host ""
          Write-Host "Testing: $baseUrl/metrics"
          try {
            $metrics = Invoke-WebRequest -Uri "$baseUrl/metrics" -Headers @{ Host = "gists.local" } -UseBasicParsing -TimeoutSec 15
            if ($metrics.Content -like "*http_requests_total*") {
              Write-Host "âœ… Metrics endpoint working" -ForegroundColor Green
            }
          } catch {
            Write-Host "âŒ Metrics check failed: $_" -ForegroundColor Red
            Stop-Job -Id $pfJob.Id -ErrorAction SilentlyContinue
            Remove-Job -Id $pfJob.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          
          # Test gists endpoint
          Write-Host ""
          Write-Host "Testing: $baseUrl/octocat"
          try {
            $gists = Invoke-RestMethod -Uri "$baseUrl/octocat" -Headers @{ Host = "gists.local" } -TimeoutSec 15
            Write-Host "âœ… Found $($gists.Count) gists for octocat" -ForegroundColor Green
          } catch {
            Write-Host "âŒ Gists endpoint failed: $_" -ForegroundColor Red
            Stop-Job -Id $pfJob.Id -ErrorAction SilentlyContinue
            Remove-Job -Id $pfJob.Id -Force -ErrorAction SilentlyContinue
            exit 1
          }
          
          # Cleanup
          Stop-Job -Id $pfJob.Id -ErrorAction SilentlyContinue
          Remove-Job -Id $pfJob.Id -Force -ErrorAction SilentlyContinue
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "ðŸŽ‰ All API tests passed!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Access your API locally:" -ForegroundColor Yellow
          Write-Host "  kubectl port-forward -n ingress-nginx svc/ingress-nginx-controller 8080:80" -ForegroundColor Cyan
          Write-Host "  curl -H 'Host: gists.local' http://localhost:8080/octocat" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Or if DNS is configured (gists.local -> 127.0.0.1):" -ForegroundColor Yellow
          Write-Host "  http://gists.local:8080/octocat" -ForegroundColor Cyan
          Write-Host ""
