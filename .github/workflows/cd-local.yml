name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
      CUSTOM_DNS: gists.kishore.local
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cluster context
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          Write-Host "[OK] Context set" -ForegroundColor Green

      - name: Build and load image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
          Write-Host "[OK] Image built and loaded" -ForegroundColor Green

      - name: Deploy application
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace ${{ env.NAMESPACE }} istio-injection=enabled --overwrite
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=2m
          Write-Host "[OK] Application deployed" -ForegroundColor Green

      - name: Setup GitHub Token Secret
        env:
          GH_TOKEN: ${{ secrets.GH_API_TOKEN }}
        run: |
          if ($env:GH_TOKEN) {
            kubectl delete secret github-token -n ${{ env.NAMESPACE }} --ignore-not-found
            kubectl create secret generic github-token --from-literal=GITHUB_TOKEN=$env:GH_TOKEN -n ${{ env.NAMESPACE }}
            kubectl rollout restart deployment/github-gists-api -n ${{ env.NAMESPACE }}
            kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=2m
            Write-Host "[OK] GitHub token secret configured (5000 req/hour)" -ForegroundColor Green
          } else {
            Write-Host "[SKIP] No GH_API_TOKEN secret - using 60 req/hour limit" -ForegroundColor Yellow
          }

      - name: Setup MetalLB for LoadBalancer IP
        run: |
          $metallbNs = kubectl get namespace metallb-system --ignore-not-found=true 2>$null
          if ([string]::IsNullOrEmpty($metallbNs)) {
            Write-Host "Installing MetalLB..." -ForegroundColor Yellow
            kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.9/config/manifests/metallb-native.yaml
            Start-Sleep -Seconds 15
            kubectl wait --namespace metallb-system --for=condition=ready pod --selector=app=metallb --timeout=120s 2>$null
          }
          
          $kindNetwork = docker network inspect kind --format "{{range .IPAM.Config}}{{.Subnet}}{{end}}" 2>$null
          if ($kindNetwork) {
            $baseIP = ($kindNetwork -split '\.')[0..1] -join '.'
            $ipRange = "$baseIP.255.200-$baseIP.255.250"
            Write-Host "Configuring MetalLB IP pool: $ipRange" -ForegroundColor Yellow
            
            $poolYaml = "apiVersion: metallb.io/v1beta1`nkind: IPAddressPool`nmetadata:`n  name: kind-pool`n  namespace: metallb-system`nspec:`n  addresses:`n  - $ipRange"
            $poolYaml | kubectl apply -f -
            
            $l2Yaml = "apiVersion: metallb.io/v1beta1`nkind: L2Advertisement`nmetadata:`n  name: kind-l2`n  namespace: metallb-system`nspec:`n  ipAddressPools:`n  - kind-pool"
            $l2Yaml | kubectl apply -f -
            
            Write-Host "[OK] MetalLB configured" -ForegroundColor Green
          }

      - name: Generate TLS Certificate
        shell: cmd
        run: |
          kubectl get secret gists-tls-secret -n istio-system >nul 2>&1 && (echo [OK] TLS certificate exists && exit /b 0)
          echo Generating TLS certificate...
          echo [req] > cert.conf
          echo distinguished_name = req_distinguished_name >> cert.conf
          echo x509_extensions = v3_req >> cert.conf
          echo prompt = no >> cert.conf
          echo [req_distinguished_name] >> cert.conf
          echo CN = gists.kishore.local >> cert.conf
          echo [v3_req] >> cert.conf
          echo keyUsage = digitalSignature, keyEncipherment >> cert.conf
          echo extendedKeyUsage = serverAuth >> cert.conf
          echo subjectAltName = @alt_names >> cert.conf
          echo [alt_names] >> cert.conf
          echo DNS.1 = gists.kishore.local >> cert.conf
          echo DNS.2 = gists.local >> cert.conf
          echo DNS.3 = *.local >> cert.conf
          "C:\Program Files\Git\usr\bin\openssl.exe" req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -config cert.conf -extensions v3_req 2>nul
          kubectl create secret tls gists-tls-secret --cert=tls.crt --key=tls.key -n istio-system --dry-run=client -o yaml | kubectl apply -f -
          del cert.conf tls.key tls.crt 2>nul
          echo [OK] TLS certificate created

      - name: Configure Istio Gateway and VirtualService
        run: |
          kubectl apply -f k8s/istio-gateway.yaml
          Write-Host "[OK] Istio Gateway configured" -ForegroundColor Green

      - name: Patch Istio Ingress Gateway for LoadBalancer
        shell: cmd
        run: |
          kubectl patch svc istio-ingressgateway -n istio-system -p "{\"spec\":{\"type\":\"LoadBalancer\"}}" --type=merge
          echo [OK] Istio Gateway patched to LoadBalancer

      - name: Wait for LoadBalancer IP
        run: |
          $retries = 0
          while ($retries -lt 15) {
            $externalIP = kubectl get svc istio-ingressgateway -n istio-system -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>$null
            if ($externalIP) {
              Write-Host "[OK] Istio Gateway LoadBalancer IP: $externalIP" -ForegroundColor Green
              break
            }
            Write-Host "Waiting for LoadBalancer IP... ($retries/15)"
            Start-Sleep -Seconds 4
            $retries++
          }

      - name: Test and display access URLs
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "DEPLOYMENT SUCCESSFUL!"
          Write-Host "========================================"
          Write-Host ""
          Write-Host "HTTPS Access - Run port-forward first:"
          Write-Host "  kubectl port-forward -n istio-system svc/istio-ingressgateway 443:443"
          Write-Host ""
          Write-Host "Then access (with hosts file: 127.0.0.1 gists.kishore.local):"
          Write-Host "  https://gists.kishore.local/health"
          Write-Host "  https://gists.kishore.local/octocat"
          Write-Host "  https://gists.local/octocat"
          Write-Host ""
          Write-Host "Or use curl:"
          Write-Host "  curl.exe -k https://gists.kishore.local/health"
          Write-Host ""

      # ========================================================================
      # MONITORING STACK DEPLOYMENT
      # ========================================================================
      - name: Add Helm Repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts 2>$null
          helm repo add grafana https://grafana.github.io/helm-charts 2>$null
          helm repo update
          Write-Host "[OK] Helm repositories configured" -ForegroundColor Green

      - name: Create Monitoring Namespace
        run: |
          kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          kubectl label namespace monitoring istio-injection=enabled --overwrite 2>$null
          Write-Host "[OK] Monitoring namespace created" -ForegroundColor Green

      - name: Setup Grafana Credentials Secret
        env:
          GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          # Use secrets or default values
          $grafanaUser = if ($env:GRAFANA_ADMIN_USER) { $env:GRAFANA_ADMIN_USER } else { "admin" }
          $grafanaPass = if ($env:GRAFANA_ADMIN_PASSWORD) { $env:GRAFANA_ADMIN_PASSWORD } else { "admin123" }
          
          # Create Grafana credentials secret
          kubectl delete secret grafana-credentials -n monitoring --ignore-not-found
          kubectl create secret generic grafana-credentials `
            --from-literal=admin-user=$grafanaUser `
            --from-literal=admin-password=$grafanaPass `
            -n monitoring
          
          Write-Host "[OK] Grafana credentials configured from GitHub secrets" -ForegroundColor Green

      - name: Generate Grafana TLS Certificate
        shell: cmd
        run: |
          kubectl get secret grafana-tls-secret -n istio-system >nul 2>&1 && (echo [OK] Grafana TLS certificate exists && exit /b 0)
          echo Generating Grafana TLS certificate...
          echo [req] > grafana-cert.conf
          echo distinguished_name = req_distinguished_name >> grafana-cert.conf
          echo x509_extensions = v3_req >> grafana-cert.conf
          echo prompt = no >> grafana-cert.conf
          echo [req_distinguished_name] >> grafana-cert.conf
          echo CN = kishoregrafana.local >> grafana-cert.conf
          echo O = Kishore >> grafana-cert.conf
          echo [v3_req] >> grafana-cert.conf
          echo keyUsage = digitalSignature, keyEncipherment >> grafana-cert.conf
          echo extendedKeyUsage = serverAuth >> grafana-cert.conf
          echo subjectAltName = @alt_names >> grafana-cert.conf
          echo [alt_names] >> grafana-cert.conf
          echo DNS.1 = kishoregrafana.local >> grafana-cert.conf
          echo DNS.2 = grafana.local >> grafana-cert.conf
          echo DNS.3 = *.monitoring.local >> grafana-cert.conf
          "C:\Program Files\Git\usr\bin\openssl.exe" req -x509 -nodes -days 365 -newkey rsa:2048 -keyout grafana-tls.key -out grafana-tls.crt -config grafana-cert.conf -extensions v3_req 2>nul
          kubectl create secret tls grafana-tls-secret --cert=grafana-tls.crt --key=grafana-tls.key -n istio-system --dry-run=client -o yaml | kubectl apply -f -
          del grafana-cert.conf grafana-tls.key grafana-tls.crt 2>nul
          echo [OK] Grafana TLS certificate created

      - name: Deploy Tempo (Distributed Tracing)
        run: |
          helm upgrade --install tempo grafana/tempo `
            --namespace monitoring `
            --values monitoring/tempo-values.yaml `
            --wait --timeout 5m0s
          Write-Host "[OK] Tempo deployed" -ForegroundColor Green

      - name: Deploy Loki (Log Aggregation)
        run: |
          helm upgrade --install loki grafana/loki-stack `
            --namespace monitoring `
            --values monitoring/loki-values.yaml `
            --wait --timeout 5m0s
          Write-Host "[OK] Loki deployed" -ForegroundColor Green

      - name: Deploy Prometheus + Grafana Stack
        env:
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          $grafanaPass = if ($env:GRAFANA_ADMIN_PASSWORD) { $env:GRAFANA_ADMIN_PASSWORD } else { "admin123" }
          
          helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack `
            --namespace monitoring `
            --values monitoring/kube-prometheus-stack-values.yaml `
            --set grafana.adminPassword=$grafanaPass `
            --set grafana.admin.existingSecret=grafana-credentials `
            --set grafana.admin.userKey=admin-user `
            --set grafana.admin.passwordKey=admin-password `
            --wait --timeout 10m0s
          Write-Host "[OK] Prometheus + Grafana deployed" -ForegroundColor Green

      - name: Deploy Synthetic Monitoring
        run: |
          kubectl apply -f monitoring/synthetic-monitoring.yaml -n monitoring
          Write-Host "[OK] Synthetic monitoring deployed" -ForegroundColor Green

      - name: Import Grafana Dashboards
        run: |
          kubectl create configmap github-gists-api-dashboard `
            --from-file=github-gists-api.json=monitoring/grafana-complete-dashboard.json `
            --namespace monitoring `
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl label configmap github-gists-api-dashboard grafana_dashboard=1 -n monitoring --overwrite
          Write-Host "[OK] Grafana dashboards imported" -ForegroundColor Green

      - name: Configure Grafana Istio Gateway
        shell: cmd
        run: |
          echo apiVersion: networking.istio.io/v1beta1 > grafana-gateway.yaml
          echo kind: Gateway >> grafana-gateway.yaml
          echo metadata: >> grafana-gateway.yaml
          echo   name: grafana-gateway >> grafana-gateway.yaml
          echo   namespace: monitoring >> grafana-gateway.yaml
          echo spec: >> grafana-gateway.yaml
          echo   selector: >> grafana-gateway.yaml
          echo     istio: ingressgateway >> grafana-gateway.yaml
          echo   servers: >> grafana-gateway.yaml
          echo   - port: >> grafana-gateway.yaml
          echo       number: 80 >> grafana-gateway.yaml
          echo       name: http >> grafana-gateway.yaml
          echo       protocol: HTTP >> grafana-gateway.yaml
          echo     hosts: >> grafana-gateway.yaml
          echo     - "kishoregrafana.local" >> grafana-gateway.yaml
          echo   - port: >> grafana-gateway.yaml
          echo       number: 443 >> grafana-gateway.yaml
          echo       name: https >> grafana-gateway.yaml
          echo       protocol: HTTPS >> grafana-gateway.yaml
          echo     tls: >> grafana-gateway.yaml
          echo       mode: SIMPLE >> grafana-gateway.yaml
          echo       credentialName: grafana-tls-secret >> grafana-gateway.yaml
          echo     hosts: >> grafana-gateway.yaml
          echo     - "kishoregrafana.local" >> grafana-gateway.yaml
          echo --- >> grafana-gateway.yaml
          echo apiVersion: networking.istio.io/v1beta1 >> grafana-gateway.yaml
          echo kind: VirtualService >> grafana-gateway.yaml
          echo metadata: >> grafana-gateway.yaml
          echo   name: grafana-vs >> grafana-gateway.yaml
          echo   namespace: monitoring >> grafana-gateway.yaml
          echo spec: >> grafana-gateway.yaml
          echo   hosts: >> grafana-gateway.yaml
          echo   - "kishoregrafana.local" >> grafana-gateway.yaml
          echo   gateways: >> grafana-gateway.yaml
          echo   - grafana-gateway >> grafana-gateway.yaml
          echo   http: >> grafana-gateway.yaml
          echo   - match: >> grafana-gateway.yaml
          echo     - uri: >> grafana-gateway.yaml
          echo         prefix: / >> grafana-gateway.yaml
          echo     route: >> grafana-gateway.yaml
          echo     - destination: >> grafana-gateway.yaml
          echo         host: kube-prometheus-stack-grafana.monitoring.svc.cluster.local >> grafana-gateway.yaml
          echo         port: >> grafana-gateway.yaml
          echo           number: 80 >> grafana-gateway.yaml
          kubectl apply -f grafana-gateway.yaml
          del grafana-gateway.yaml
          echo [OK] Grafana Istio Gateway configured

      - name: Display Monitoring Access Info
        run: |
          $ingressIP = kubectl get svc istio-ingressgateway -n istio-system -o jsonpath="{.status.loadBalancer.ingress[0].ip}" 2>$null
          if (-not $ingressIP) { $ingressIP = "127.0.0.1 (via port-forward)" }
          
          Write-Host ""
          Write-Host "========================================"
          Write-Host "MONITORING STACK DEPLOYED!"
          Write-Host "========================================"
          Write-Host ""
          Write-Host "Add to Windows hosts file (C:\Windows\System32\drivers\etc\hosts):"
          Write-Host "  $ingressIP    kishoregrafana.local"
          Write-Host "  $ingressIP    gists.kishore.local"
          Write-Host ""
          Write-Host "Grafana Access:"
          Write-Host "  URL:      https://kishoregrafana.local"
          Write-Host "  User:     admin (or from GRAFANA_ADMIN_USER secret)"
          Write-Host "  Password: From GRAFANA_ADMIN_PASSWORD secret"
          Write-Host ""
          Write-Host "API Access:"
          Write-Host "  https://gists.kishore.local/health"
          Write-Host "  https://gists.kishore.local/{username}"
          Write-Host ""
          Write-Host "Monitoring Components:"
          Write-Host "  - Prometheus (Metrics)"
          Write-Host "  - Grafana (Visualization)"
          Write-Host "  - Loki (Logs)"
          Write-Host "  - Tempo (Traces)"
          Write-Host "  - Blackbox Exporter (Synthetic)"
          Write-Host ""

