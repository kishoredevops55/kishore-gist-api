name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]  # Match your runner labels
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    env:
      CLUSTER_NAME: kind-dev
      CONTEXT_NAME: kind-kind-dev
      IMAGE_NAME: github-gists-api:latest
      NAMESPACE: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be available via Docker Desktop
          kubectl version --client

      - name: Ensure Kind cluster exists with ingress port mappings
        run: |
          $clusters = kind get clusters 2>$null
          if ($clusters -notcontains "${{ env.CLUSTER_NAME }}") {
            Write-Host "Creating kind cluster ${{ env.CLUSTER_NAME }} with ingress support..."
            
            # Create temporary kind config file
            $kindConfig = @'
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
          '@
            
            $kindConfig | Out-File -FilePath kind-config.yaml -Encoding utf8
            kind create cluster --name ${{ env.CLUSTER_NAME }} --config kind-config.yaml
            Remove-Item kind-config.yaml
            
            Write-Host "‚úÖ Kind cluster created with ingress port mappings"
          } else {
            Write-Host "‚úÖ Kind cluster ${{ env.CLUSTER_NAME }} already exists"
          }
      
      - name: Configure Kind cluster context (kind-dev)
        run: |
          kubectl config use-context ${{ env.CONTEXT_NAME }}
          kubectl cluster-info
      
      - name: Install ingress-nginx controller
        run: |
          # Check if ingress-nginx namespace exists
          $ingressNs = kubectl get namespace ingress-nginx --ignore-not-found=true
          if ([string]::IsNullOrEmpty($ingressNs)) {
            Write-Host "Installing ingress-nginx controller..."
            kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
            
            Write-Host "Waiting for ingress-nginx controller to be ready..."
            kubectl wait --namespace ingress-nginx `
              --for=condition=ready pod `
              --selector=app.kubernetes.io/component=controller `
              --timeout=180s
            
            Write-Host "‚úÖ Ingress-nginx controller installed and ready"
          } else {
            Write-Host "‚úÖ Ingress-nginx controller already installed"
            # Verify it's running
            kubectl get pods -n ingress-nginx -l app.kubernetes.io/component=controller
          }

      - name: Build local image
        run: |
          docker build -t ${{ env.IMAGE_NAME }} .
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Load local image into Kind cluster (kind-dev)
        run: |
          # Load the locally built image into Kind (expects image tag github-gists-api:latest)
          kind load docker-image ${{ env.IMAGE_NAME }} --name ${{ env.CLUSTER_NAME }}
      
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret `
            --docker-server=https://index.docker.io/v1/ `
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} `
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} `
            --namespace=${{ env.NAMESPACE }} `
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kind cluster
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/servicemonitor.yaml
          kubectl apply -f k8s/ingress-nginx.yaml
          kubectl rollout status deployment/github-gists-api -n ${{ env.NAMESPACE }} --timeout=3m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=github-gists-api
          kubectl get ingress -n ${{ env.NAMESPACE }}
      
      - name: Configure local DNS (Windows hosts file)
        continue-on-error: true
        run: |
          $hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
          $dnsEntry = "127.0.0.1 gists.local"
          
          # Check if entry already exists
          $existingEntry = Get-Content $hostsFile | Select-String -Pattern "gists.local"
          
          if (-not $existingEntry) {
            Write-Host "‚ö†Ô∏è  DNS entry not found in hosts file" -ForegroundColor Yellow
            Write-Host "Please run as Administrator:" -ForegroundColor Yellow
            Write-Host "  Add-Content -Path C:\Windows\System32\drivers\etc\hosts -Value '127.0.0.1 gists.local'" -ForegroundColor Cyan
            Write-Host ""
            Write-Host "Or manually add this line to C:\Windows\System32\drivers\etc\hosts:" -ForegroundColor Yellow
            Write-Host "  127.0.0.1 gists.local" -ForegroundColor Cyan
          } else {
            Write-Host "‚úÖ DNS entry already exists: $existingEntry" -ForegroundColor Green
          }
      
      - name: Wait for ingress to be ready
        run: |
          Write-Host "Waiting for ingress controller and backends to be ready..." -ForegroundColor Yellow
          Write-Host ""
          
          # Wait for ingress controller pods
          kubectl wait --namespace ingress-nginx `
            --for=condition=ready pod `
            --selector=app.kubernetes.io/component=controller `
            --timeout=60s
          
          Write-Host "‚úÖ Ingress controller is ready" -ForegroundColor Green
          Write-Host ""
          
          # Wait for application pods
          kubectl wait --namespace ${{ env.NAMESPACE }} `
            --for=condition=ready pod `
            --selector=app=github-gists-api `
            --timeout=60s
          
          Write-Host "‚úÖ Application pods are ready" -ForegroundColor Green
          Write-Host ""
          
          # Additional wait for ingress routing to stabilize
          Write-Host "Waiting for ingress routing to stabilize..."
          Start-Sleep -Seconds 15
          
          # Show ingress details
          Write-Host ""
          Write-Host "Ingress details:" -ForegroundColor Cyan
          kubectl describe ingress github-gists-api -n ${{ env.NAMESPACE }}
          
          Write-Host ""
          Write-Host "Ingress controller service:" -ForegroundColor Cyan
          kubectl get svc -n ingress-nginx
      
      - name: Test API via Ingress (Production-grade)
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Testing API via Ingress Load Balancer" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          
          # Check if DNS is configured
          $hostsFile = "$env:SystemRoot\System32\drivers\etc\hosts"
          $dnsConfigured = (Get-Content $hostsFile | Select-String -Pattern "gists.local") -ne $null
          
          if ($dnsConfigured) {
            Write-Host "‚úÖ DNS configured for gists.local" -ForegroundColor Green
            $baseUrl = "http://gists.local"
          } else {
            Write-Host "‚ö†Ô∏è  DNS not configured, using localhost with Host header" -ForegroundColor Yellow
            $baseUrl = "http://localhost"
          }
          
          Write-Host ""
          
          # Test health endpoint
          Write-Host "Testing: $baseUrl/health"
          try {
            if ($dnsConfigured) {
              $health = Invoke-RestMethod -Uri "$baseUrl/health" -TimeoutSec 10
            } else {
              $health = Invoke-RestMethod -Uri "$baseUrl/health" -Headers @{ Host = "gists.local" } -TimeoutSec 10
            }
            Write-Host "‚úÖ Health check: $($health.status)" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Health check failed: $_" -ForegroundColor Red
            Write-Host ""
            Write-Host "Troubleshooting information:" -ForegroundColor Yellow
            Write-Host "1. Check ingress controller logs:"
            Write-Host "   kubectl logs -n ingress-nginx -l app.kubernetes.io/component=controller --tail=50"
            Write-Host ""
            Write-Host "2. Check application logs:"
            Write-Host "   kubectl logs -n ${{ env.NAMESPACE }} -l app=github-gists-api --tail=50"
            Write-Host ""
            Write-Host "3. Verify ingress backend:"
            Write-Host "   kubectl describe ingress github-gists-api -n ${{ env.NAMESPACE }}"
            exit 1
          }
          
          # Test metrics endpoint
          Write-Host ""
          Write-Host "Testing: $baseUrl/metrics"
          try {
            if ($dnsConfigured) {
              $metrics = Invoke-WebRequest -Uri "$baseUrl/metrics" -UseBasicParsing -TimeoutSec 10
            } else {
              $metrics = Invoke-WebRequest -Uri "$baseUrl/metrics" -Headers @{ Host = "gists.local" } -UseBasicParsing -TimeoutSec 10
            }
            if ($metrics.Content -like "*http_requests_total*") {
              Write-Host "‚úÖ Metrics endpoint working" -ForegroundColor Green
            }
          } catch {
            Write-Host "‚ùå Metrics check failed: $_" -ForegroundColor Red
            exit 1
          }
          
          # Test gists endpoint
          Write-Host ""
          Write-Host "Testing: $baseUrl/octocat"
          try {
            if ($dnsConfigured) {
              $gists = Invoke-RestMethod -Uri "$baseUrl/octocat" -TimeoutSec 10
            } else {
              $gists = Invoke-RestMethod -Uri "$baseUrl/octocat" -Headers @{ Host = "gists.local" } -TimeoutSec 10
            }
            Write-Host "‚úÖ Found $($gists.Count) gists for octocat" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Gists endpoint failed: $_" -ForegroundColor Red
            exit 1
          }
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üéâ All API tests passed!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Access your API at: http://gists.local/<username>" -ForegroundColor Yellow
          Write-Host "Example: http://gists.local/octocat" -ForegroundColor Yellow
          Write-Host ""
          Stop-Job -Name *
