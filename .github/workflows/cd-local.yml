name: CD Pipeline (Local Kind Cluster)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-to-kind:
    runs-on: [self-hosted, Windows, X64]  # Match your runner labels
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        run: |
          # kubectl should already be available via Docker Desktop
          kubectl version --client
      
      - name: Configure Kind cluster context (kind-dev)
        run: |
          kubectl config use-context kind-kind-dev
          kubectl cluster-info
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Load local image into Kind cluster (kind-dev)
        run: |
          # Load the locally built image into Kind (expects image tag github-gists-api:latest)
          kind load docker-image github-gists-api:latest --name kind-dev
      
      - name: Create DockerHub pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret `
            --docker-server=https://index.docker.io/v1/ `
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} `
            --docker-password=${{ secrets.DOCKERHUB_TOKEN }} `
            --namespace=production `
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy to Kind cluster
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/servicemonitor.yaml
          kubectl rollout status deployment/github-gists-api -n production --timeout=3m
      
      - name: Verify deployment
        run: |
          kubectl get pods -n production -l app=github-gists-api
          kubectl get svc -n production -l app=github-gists-api
      
      - name: Port forward and test
        run: |
          Start-Job -ScriptBlock {
            kubectl port-forward -n production svc/github-gists-api 8080:80
          }
          Start-Sleep -Seconds 5
          
          # Test health endpoint
          $response = Invoke-RestMethod http://localhost:8080/health
          Write-Host "Health check: $($response.status)"
          
          # Test metrics endpoint
          $metrics = Invoke-WebRequest http://localhost:8080/metrics
          Write-Host "Metrics endpoint: Available"
          
          Stop-Job -Name *
