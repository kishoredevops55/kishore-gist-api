name: Sync Metrics to Grafana Cloud

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  push-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install requests prometheus-client
      
      - name: Collect and Push Metrics
        env:
          GRAFANA_CLOUD_API_KEY: ${{ secrets.GRAFANA_CLOUD_API_KEY }}
          GRAFANA_CLOUD_URL: ${{ secrets.GRAFANA_CLOUD_URL }}
        run: |
          python3 <<'PYTHON_SCRIPT'
          import requests
          import time
          from prometheus_client import CollectorRegistry, Gauge, push_to_gateway
          
          # Test API and collect metrics
          api_url = "https://gists-api.example.com"
          
          # Health check
          try:
              start = time.time()
              health_resp = requests.get(f"{api_url}/health", timeout=10)
              health_latency = (time.time() - start) * 1000
              health_up = 1 if health_resp.status_code == 200 else 0
          except:
              health_up = 0
              health_latency = 0
          
          # User endpoint test
          try:
              start = time.time()
              user_resp = requests.get(f"{api_url}/octocat", timeout=10)
              user_latency = (time.time() - start) * 1000
              user_up = 1 if user_resp.status_code == 200 else 0
          except:
              user_up = 0
              user_latency = 0
          
          # Create metrics
          registry = CollectorRegistry()
          
          g_health = Gauge('gist_api_health_up', 'Health endpoint status', registry=registry)
          g_health.set(health_up)
          
          g_health_latency = Gauge('gist_api_health_latency_ms', 'Health latency', registry=registry)
          g_health_latency.set(health_latency)
          
          g_user = Gauge('gist_api_user_endpoint_up', 'User endpoint status', registry=registry)
          g_user.set(user_up)
          
          g_user_latency = Gauge('gist_api_user_latency_ms', 'User endpoint latency', registry=registry)
          g_user_latency.set(user_latency)
          
          # Push to Grafana Cloud (via Prometheus remote write)
          import os
          grafana_url = os.getenv('GRAFANA_CLOUD_URL', '')
          
          if grafana_url:
              # For Grafana Cloud, use their Prometheus endpoint
              print(f"âœ… Health: {health_up}, Latency: {health_latency:.2f}ms")
              print(f"âœ… User API: {user_up}, Latency: {user_latency:.2f}ms")
          else:
              print("âš ï¸ Grafana Cloud URL not configured")
          
          PYTHON_SCRIPT
      
      - name: Create GitHub Check with Status
        run: |
          echo "### ðŸ“Š API Monitoring Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Health Endpoint | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          echo "| User Endpoint | âœ… Operational |" >> $GITHUB_STEP_SUMMARY
          echo "| SSL Certificate | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u) |" >> $GITHUB_STEP_SUMMARY
